<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f7fa;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header h1 {
      font-size: 24px;
    }
    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.3s;
    }
    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    .stats {
      display: flex;
      gap: 20px;
      padding: 30px 40px;
    }
    .stat-card {
      flex: 1;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .stat-card h3 {
      color: #888;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    .stat-card .number {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
    }
    .container {
      padding: 0 40px 40px;
    }
    .controls {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .search-box {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }
    .search-box:focus {
      outline: none;
      border-color: #667eea;
    }
    .btn {
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    .btn:hover {
      background: #5568d3;
    }
    .data-table {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .table-header {
      background: #f8f9fa;
      padding: 15px 20px;
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid #e9ecef;
    }
    .data-entry {
      padding: 20px;
      border-bottom: 1px solid #e9ecef;
      transition: background 0.2s;
    }
    .data-entry:hover {
      background: #f8f9fa;
    }
    .data-entry:last-child {
      border-bottom: none;
    }
    .entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .entry-id {
      font-weight: bold;
      color: #667eea;
      font-size: 14px;
    }
    .entry-time {
      color: #888;
      font-size: 13px;
    }
    .entry-actions {
      display: flex;
      gap: 10px;
    }
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .view-btn {
      background: #667eea;
      color: white;
    }
    .view-btn:hover {
      background: #5568d3;
    }
    .delete-btn {
      background: #dc3545;
      color: white;
    }
    .delete-btn:hover {
      background: #c82333;
    }
    .entry-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      font-size: 14px;
    }
    .summary-item {
      display: flex;
      flex-direction: column;
    }
    .summary-label {
      color: #888;
      font-size: 12px;
      margin-bottom: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .summary-value {
      color: #333;
      font-weight: 500;
    }
    .vpn-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .vpn-yes {
      background: #fee;
      color: #c00;
    }
    .vpn-no {
      background: #efe;
      color: #0a0;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      overflow-y: auto;
    }
    .modal-content {
      background: white;
      margin: 30px auto;
      padding: 0;
      border-radius: 15px;
      max-width: 1100px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      color: white;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .modal-body-wrapper {
      padding: 30px;
      overflow-y: auto;
      flex: 1;
      max-height: calc(90vh - 80px);
    }
    .modal-body-wrapper::-webkit-scrollbar {
      width: 10px;
    }
    .modal-body-wrapper::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    .modal-body-wrapper::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 10px;
    }
    .modal-body-wrapper::-webkit-scrollbar-thumb:hover {
      background: #5568d3;
    }
    .close-btn {
      font-size: 32px;
      color: rgba(255,255,255,0.8);
      cursor: pointer;
      border: none;
      background: none;
      transition: color 0.2s;
    }
    .close-btn:hover {
      color: white;
    }
    .info-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    .info-card {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s;
    }
    .info-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    .info-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e9ecef;
    }
    .info-card-icon {
      font-size: 24px;
    }
    .info-card-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
    }
    .info-card-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f1f3f5;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-weight: 600;
      color: #666;
      font-size: 13px;
    }
    .info-value {
      color: #333;
      font-size: 13px;
      font-weight: 500;
      text-align: right;
      max-width: 60%;
      word-break: break-word;
    }
    .info-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    .collapsible-section {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      margin-bottom: 15px;
      overflow: hidden;
    }
    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      cursor: pointer;
      background: #f8f9fa;
      transition: background 0.2s;
    }
    .collapsible-header:hover {
      background: #e9ecef;
    }
    .collapsible-title {
      font-weight: 700;
      color: #333;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .collapsible-arrow {
      font-size: 18px;
      transition: transform 0.3s;
    }
    .collapsible-arrow.open {
      transform: rotate(90deg);
    }
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .collapsible-content.open {
      max-height: 2000px;
      transition: max-height 0.5s ease-in;
    }
    .collapsible-body {
      padding: 20px;
      background: #f8f9fa;
    }
    .data-table-mini {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    .data-table-mini th {
      background: #667eea;
      color: white;
      padding: 12px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
    }
    .data-table-mini td {
      padding: 10px 12px;
      border-bottom: 1px solid #e9ecef;
      font-size: 13px;
      color: #333;
    }
    .data-table-mini tr:last-child td {
      border-bottom: none;
    }
    .data-table-mini tr:hover {
      background: #f8f9fa;
    }
    .code-block {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    .empty-state {
      text-align: center;
      padding: 30px;
      color: #999;
      font-style: italic;
    }
    .no-data {
      text-align: center;
      padding: 60px;
      color: #888;
      font-size: 18px;
    }
    .fingerprint-container {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      margin-top: 5px;
    }
    .fingerprint-value {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      color: #333;
      word-break: break-all;
      flex: 1;
      line-height: 1.5;
    }
    .copy-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .copy-btn:hover {
      background: #5568d3;
    }
    .copy-btn:active {
      transform: scale(0.95);
    }
    .copy-btn.copied {
      background: #28a745;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üîê Admin Dashboard</h1>
    <a href="/admin/logout" class="logout-btn">Logout</a>
  </div>

  <div class="stats">
    <div class="stat-card">
      <h3>Total Records</h3>
      <div class="number">{{ count }}</div>
    </div>
    <div class="stat-card">
      <h3>Today</h3>
      <div class="number" id="todayCount">0</div>
    </div>
    <div class="stat-card">
      <h3>VPN Detected</h3>
      <div class="number" id="vpnCount">0</div>
    </div>
  </div>

  <div class="container">
    <div class="controls">
      <input type="text" id="searchBox" class="search-box" placeholder="Search by IP, fingerprint, location...">
      <button class="btn" onclick="exportData()">Export CSV</button>
      <button class="btn" onclick="location.reload()">Refresh</button>
    </div>

    <div class="data-table">
      <div class="table-header">
        Collected User Data
      </div>

      {% if count == 0 %}
      <div class="no-data">
        No data collected yet. Share the main page with users to start collecting data.
      </div>
      {% else %}
      <div id="dataEntries">
        {% for entry in data %}
        <div class="data-entry" data-search="{{ entry.ip_address }} {{ entry.fingerprint }} {{ entry.location_data.city }} {{ entry.location_data.country }}">
          <div class="entry-header">
            <div>
              <span class="entry-id">#{{ entry.id }}</span>
              <span class="entry-time">{{ entry.timestamp }}</span>
            </div>
            <div class="entry-actions">
              <button class="action-btn view-btn" onclick="viewDetails({{ entry.id }})">View Details</button>
              <button class="action-btn delete-btn" onclick="deleteEntry({{ entry.id }})">Delete</button>
            </div>
          </div>

          <div class="entry-summary">
            <div class="summary-item">
              <span class="summary-label">IP Address</span>
              <span class="summary-value">{{ entry.ip_address or 'N/A' }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Location</span>
              <span class="summary-value">
                {% if entry.location_data.city %}
                  {{ entry.location_data.city }}, {{ entry.location_data.country }}
                {% else %}
                  N/A
                {% endif %}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Browser / OS</span>
              <span class="summary-value">
                {% if entry.device_info.browser %}
                  {{ entry.device_info.browser }} / {{ entry.device_info.os }}
                {% else %}
                  N/A
                {% endif %}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">VPN/Proxy</span>
              <span class="summary-value">
                {% if entry.vpn_detection.isVPN %}
                  <span class="vpn-badge vpn-yes">Yes</span>
                {% else %}
                  <span class="vpn-badge vpn-no">No</span>
                {% endif %}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Fingerprint</span>
              <span class="summary-value" style="font-family: monospace; font-size: 11px;">{{ entry.fingerprint[:16] }}...</span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Modal for detailed view -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Entry Details</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const allData = {{ data | tojson }};

    // Calculate stats
    const today = new Date().toISOString().split('T')[0];
    const todayCount = allData.filter(e => e.timestamp.startsWith(today)).length;
    const vpnCount = allData.filter(e => e.vpn_detection?.isVPN).length;
    document.getElementById('todayCount').textContent = todayCount;
    document.getElementById('vpnCount').textContent = vpnCount;

    // Search functionality
    document.getElementById('searchBox').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const entries = document.querySelectorAll('.data-entry');

      entries.forEach(entry => {
        const searchText = entry.getAttribute('data-search').toLowerCase();
        if (searchText.includes(searchTerm)) {
          entry.style.display = 'block';
        } else {
          entry.style.display = 'none';
        }
      });
    });

    function viewDetails(id) {
      const entry = allData.find(e => e.id === id);
      if (!entry) return;

      const dev = entry.device_info || {};
      const loc = entry.location_data || {};
      const vpn = entry.vpn_detection || {};
      const storage = entry.storage_info || {};
      const conn = entry.connection_info || {};

      const formatDate = (timestamp) => {
        const d = new Date(timestamp);
        return d.toLocaleString('en-US', {
          year: 'numeric', month: 'short', day: 'numeric',
          hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
      };

      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <div class="modal-body-wrapper">
          <!-- Info Cards Grid -->
          <div class="info-cards-grid">
            <!-- Identity Card -->
            <div class="info-card" style="grid-column: span 2;">
              <div class="info-card-header">
                <span class="info-card-icon">üÜî</span>
                <span class="info-card-title">Identity</span>
              </div>
              <div class="info-card-body">
                <div class="info-row">
                  <span class="info-label">Entry ID</span>
                  <span class="info-value">#${entry.id}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Timestamp</span>
                  <span class="info-value">${formatDate(entry.timestamp)}</span>
                </div>
                <div style="border-bottom: none; padding: 8px 0 0 0;">
                  <div style="font-weight: 600; color: #666; font-size: 13px; margin-bottom: 8px;">Fingerprint (SHA-256)</div>
                  <div class="fingerprint-container">
                    <div class="fingerprint-value" id="fingerprint-${entry.id}">${entry.fingerprint || 'N/A'}</div>
                    <button class="copy-btn" onclick="copyFingerprint('${entry.fingerprint}', ${entry.id})">Copy</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Network Card -->
            <div class="info-card">
              <div class="info-card-header">
                <span class="info-card-icon">üåê</span>
                <span class="info-card-title">Network</span>
              </div>
              <div class="info-card-body">
                <div class="info-row">
                  <span class="info-label">IP Address</span>
                  <span class="info-value">${entry.ip_address || 'N/A'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Provider</span>
                  <span class="info-value">${loc.provider || 'N/A'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Organization</span>
                  <span class="info-value">${loc.org || 'N/A'}</span>
                </div>
              </div>
            </div>

            <!-- Location Card -->
            <div class="info-card">
              <div class="info-card-header">
                <span class="info-card-icon">üìç</span>
                <span class="info-card-title">Location</span>
              </div>
              <div class="info-card-body">
                <div class="info-row">
                  <span class="info-label">Country</span>
                  <span class="info-value">${loc.country || 'N/A'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">City</span>
                  <span class="info-value">${loc.city || 'N/A'} ${loc.region ? ', ' + loc.region : ''}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Coordinates</span>
                  <span class="info-value">${loc.latitude && loc.longitude ? `${loc.latitude}, ${loc.longitude}` : 'N/A'}</span>
                </div>
              </div>
            </div>

            <!-- Device Card -->
            <div class="info-card">
              <div class="info-card-header">
                <span class="info-card-icon">üíª</span>
                <span class="info-card-title">Device</span>
              </div>
              <div class="info-card-body">
                <div class="info-row">
                  <span class="info-label">Browser</span>
                  <span class="info-value">${dev.browser || 'N/A'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">OS</span>
                  <span class="info-value">${dev.os || 'N/A'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Platform</span>
                  <span class="info-value">${dev.platform || 'N/A'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Mobile</span>
                  <span class="info-value">${dev.mobile === 'Yes' ? '‚úì Yes' : '‚úó No'}</span>
                </div>
              </div>
            </div>

            <!-- Security Card -->
            <div class="info-card">
              <div class="info-card-header">
                <span class="info-card-icon">üõ°Ô∏è</span>
                <span class="info-card-title">Security Status</span>
              </div>
              <div class="info-card-body">
                <div class="info-row">
                  <span class="info-label">VPN/Proxy</span>
                  <span class="info-value">
                    ${vpn.isVPN
                      ? '<span class="info-badge badge-danger">Detected</span>'
                      : '<span class="info-badge badge-success">Not Detected</span>'}
                  </span>
                </div>
                <div class="info-row">
                  <span class="info-label">Risk Score</span>
                  <span class="info-value">
                    ${vpn.score >= 50
                      ? '<span class="info-badge badge-danger">' + vpn.score + '</span>'
                      : vpn.score >= 30
                        ? '<span class="info-badge badge-warning">' + vpn.score + '</span>'
                        : '<span class="info-badge badge-success">' + (vpn.score || 0) + '</span>'}
                  </span>
                </div>
                ${vpn.reasons && vpn.reasons.length > 0 ? `
                <div class="info-row">
                  <span class="info-label">Reasons</span>
                  <span class="info-value" style="max-width: 70%;">${vpn.reasons.join(', ')}</span>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Screen Info Card -->
            <div class="info-card">
              <div class="info-card-header">
                <span class="info-card-icon">üñ•Ô∏è</span>
                <span class="info-card-title">Display</span>
              </div>
              <div class="info-card-body">
                <div class="info-row">
                  <span class="info-label">Resolution</span>
                  <span class="info-value">${dev.screen ? `${dev.screen.width}√ó${dev.screen.height}` : 'N/A'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Color Depth</span>
                  <span class="info-value">${dev.screen?.colorDepth ? dev.screen.colorDepth + '-bit' : 'N/A'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Orientation</span>
                  <span class="info-value">${dev.screen?.orientation || 'N/A'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Touch Support</span>
                  <span class="info-value">${dev.touch === 'Yes' ? '‚úì Yes' : '‚úó No'}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Collapsible Sections -->
          ${createCollapsible('timezone', 'üïí Timezone & Locale', `
            <div class="info-row">
              <span class="info-label">Timezone</span>
              <span class="info-value">${dev.timezone?.name || 'N/A'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">UTC Offset</span>
              <span class="info-value">UTC${dev.timezone?.offset >= 0 ? '+' : ''}${dev.timezone?.offset || 0}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Current Time</span>
              <span class="info-value">${dev.timezone?.current || 'N/A'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Browser Language</span>
              <span class="info-value">${dev.language || dev.locales?.browser || 'N/A'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">System Locale</span>
              <span class="info-value">${dev.locales?.system || 'N/A'}</span>
            </div>
          `)}

          ${createCollapsible('hardware', '‚öôÔ∏è Hardware Specs', `
            <div class="info-row">
              <span class="info-label">CPU Cores</span>
              <span class="info-value">${dev.cores || 'Unknown'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Memory (RAM)</span>
              <span class="info-value">${dev.memory ? dev.memory + ' GB' : 'Unknown'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">User Agent</span>
              <span class="info-value" style="max-width: 80%; word-break: break-all;">${entry.user_agent || 'N/A'}</span>
            </div>
          `)}

          ${storage.cookies && storage.cookies.length > 0 ? createCollapsible('cookies', 'üç™ Cookies (' + storage.cookies.length + ')', `
            ${storage.cookies.length > 0 ? `
            <table class="data-table-mini">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                ${storage.cookies.slice(0, 20).map(c => `
                <tr>
                  <td style="font-weight: 600;">${c.name || 'N/A'}</td>
                  <td style="font-family: monospace; font-size: 11px;">${(c.value || '').substring(0, 50)}${(c.value || '').length > 50 ? '...' : ''}</td>
                </tr>
                `).join('')}
              </tbody>
            </table>
            ${storage.cookies.length > 20 ? '<div style="text-align: center; margin-top: 10px; color: #666; font-size: 12px;">... and ' + (storage.cookies.length - 20) + ' more</div>' : ''}
            ` : '<div class="empty-state">No cookies found</div>'}
          `) : ''}

          ${createCollapsible('storage', 'üíæ Browser Storage', `
            <div style="margin-bottom: 15px;">
              <strong style="color: #667eea;">localStorage:</strong>
              ${storage.localStorage && storage.localStorage.count > 0 ? `
                <div style="margin-top: 8px; color: #666;">Count: ${storage.localStorage.count} items</div>
              ` : '<div style="margin-top: 8px; color: #999;">Empty</div>'}
            </div>
            <div style="margin-bottom: 15px;">
              <strong style="color: #667eea;">sessionStorage:</strong>
              ${storage.sessionStorage && storage.sessionStorage.count > 0 ? `
                <div style="margin-top: 8px; color: #666;">Count: ${storage.sessionStorage.count} items</div>
              ` : '<div style="margin-top: 8px; color: #999;">Empty</div>'}
            </div>
            <div>
              <strong style="color: #667eea;">IndexedDB:</strong>
              ${storage.indexedDB && storage.indexedDB.supported ? `
                <div style="margin-top: 8px; color: #666;">
                  ${storage.indexedDB.count > 0 ? 'Databases: ' + storage.indexedDB.count : 'No databases'}
                </div>
              ` : '<div style="margin-top: 8px; color: #999;">Not supported</div>'}
            </div>
          `)}

          ${createCollapsible('connection', 'üîí Connection Info', `
            <div class="info-row">
              <span class="info-label">Protocol</span>
              <span class="info-value">${conn.tls?.protocol || 'N/A'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Secure Connection</span>
              <span class="info-value">
                ${conn.tls?.isSecure
                  ? '<span class="info-badge badge-success">‚úì HTTPS</span>'
                  : '<span class="info-badge badge-danger">‚úó HTTP</span>'}
              </span>
            </div>
          `)}

          ${createCollapsible('raw', 'üìÑ Raw Data (JSON)', `
            <div class="code-block">${JSON.stringify(JSON.parse(entry.raw_data || '{}'), null, 2)}</div>
          `)}
        </div>
      `;

      // Add click handlers for collapsibles
      document.querySelectorAll('.collapsible-header').forEach(header => {
        header.addEventListener('click', function() {
          const content = this.nextElementSibling;
          const arrow = this.querySelector('.collapsible-arrow');
          content.classList.toggle('open');
          arrow.classList.toggle('open');
        });
      });

      document.getElementById('detailModal').style.display = 'block';
    }

    function createCollapsible(id, title, content) {
      return `
        <div class="collapsible-section">
          <div class="collapsible-header">
            <div class="collapsible-title">${title}</div>
            <div class="collapsible-arrow">‚ñ∂</div>
          </div>
          <div class="collapsible-content">
            <div class="collapsible-body">
              ${content}
            </div>
          </div>
        </div>
      `;
    }

    function closeModal() {
      document.getElementById('detailModal').style.display = 'none';
    }

    async function deleteEntry(id) {
      if (!confirm('Are you sure you want to delete this entry?')) return;

      try {
        const response = await fetch(`/admin/api/delete/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          location.reload();
        } else {
          alert('Failed to delete entry');
        }
      } catch (error) {
        alert('Error deleting entry: ' + error.message);
      }
    }

    function exportData() {
      // Convert data to CSV
      const headers = ['ID', 'Timestamp', 'IP Address', 'Browser', 'OS', 'Location', 'VPN', 'Fingerprint'];
      const rows = allData.map(e => [
        e.id,
        e.timestamp,
        e.ip_address || '',
        e.device_info?.browser || '',
        e.device_info?.os || '',
        `${e.location_data?.city || ''} ${e.location_data?.country || ''}`.trim(),
        e.vpn_detection?.isVPN ? 'Yes' : 'No',
        e.fingerprint || ''
      ]);

      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += row.map(cell => `"${cell}"`).join(',') + '\n';
      });

      // Download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `user_data_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Copy fingerprint function
    function copyFingerprint(fingerprint, entryId) {
      if (!fingerprint || fingerprint === 'N/A') return;

      // Copy to clipboard
      navigator.clipboard.writeText(fingerprint).then(() => {
        // Find all copy buttons with this entry ID
        const buttons = document.querySelectorAll('.copy-btn');
        buttons.forEach(btn => {
          if (btn.getAttribute('onclick')?.includes(`${entryId}`)) {
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.classList.add('copied');

            // Reset after 2 seconds
            setTimeout(() => {
              btn.textContent = originalText;
              btn.classList.remove('copied');
            }, 2000);
          }
        });
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy fingerprint');
      });
    }

    // Close modal on outside click
    window.onclick = function(event) {
      const modal = document.getElementById('detailModal');
      if (event.target === modal) {
        closeModal();
      }
    }
  </script>
</body>
</html>